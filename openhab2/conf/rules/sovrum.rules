var Timer ON_Timer = null
var Timer OFF_Timer = null
val java.util.Random rand = new java.util.Random

rule "Sovrum evening on"
when
  Time cron "0 45 18 * * ?"
then
  if(ON_Timer === null) {
    val timeout = rand.nextInt(30)
    logInfo("Sovrum", "Evening on in " + timeout + " minutes")
    ON_Timer = createTimer(now.plusMinutes(timeout))
    [|
      logInfo("Sovrum", "Evening on")
      Sovrum.sendCommand(ON)
      ON_Timer = null
    ]
  }
end

rule "Sovrum evening off"
when
  Time cron "0 00 21 * * ?"
then
  if(OFF_Timer === null) {
    val timeout = rand.nextInt(60)
    logInfo("Sovrum", "Evening off in " + timeout + " minutes")
    OFF_Timer = createTimer(now.plusMinutes(timeout))
    [|
      logInfo("Sovrum", "Evening off")
      Sovrum.sendCommand(OFF)
      OFF_Timer = null
    ]
  }
end
